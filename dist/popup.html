<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manga Text Processor</title>
  <script type="module" crossorigin src="./assets/popup-CeoadZ4S.js"></script>
  <link rel="stylesheet" crossorigin href="./styles/popup-DroTYoDx.css">
</head>
<body data-theme="dark">
  <div class="app" role="application" aria-label="Manga Text Processor">
    <!-- ===== MAIN CONTENT ===== -->
    <main id="main-content" class="main" role="main">
      <h1 class="sr-only">Manga Text Processor</h1>

      <!-- Server URL Configuration with inline status -->
      <section class="server-config" aria-labelledby="server-config-label">
        <label for="serverUrl" id="server-config-label" class="sr-only">Server URL</label>
        <div class="server-url-wrapper">
          <input
            type="url"
            id="serverUrl"
            class="server-url-input"
            placeholder="http://localhost:1420"
            value="http://localhost:1420"
            aria-describedby="server-url-help"
            aria-required="true"
          >
          <div class="server-status">
            <div
              id="connectionStatus"
              class="status-dot checking"
              role="status"
              aria-live="polite"
              aria-label="Server connection status: checking">
            </div>
            <span class="status-label" id="connectionLabel">Checking...</span>
          </div>
        </div>
        <span id="server-url-help" class="sr-only">Enter the URL of your local manga processing server</span>
      </section>

      <!-- Quick Actions -->
      <section class="quick-actions" aria-labelledby="actions-heading">
        <h2 id="actions-heading" class="sr-only">Quick Actions</h2>
        <div class="action-buttons">
          <button type="button" class="action-btn action-btn-primary" id="processAllBtn" aria-label="Process all images on page">
            <div class="action-btn-content">
              <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
              </svg>
              <span class="action-btn-label">Process All</span>
            </div>
            <div class="action-btn-shortcut">
              <kbd>Alt</kbd><span>+</span><kbd>Q</kbd>
            </div>
          </button>
          <button type="button" class="action-btn action-btn-secondary" id="selectImageBtn" aria-label="Select and process single image">
            <div class="action-btn-content">
              <svg class="action-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
              </svg>
              <span class="action-btn-label">Select Image</span>
            </div>
            <div class="action-btn-shortcut">
              <kbd>Alt</kbd><span>+</span><kbd>W</kbd>
            </div>
          </button>
        </div>
      </section>

      <!-- Tab Navigation -->
      <nav class="tabs" role="tablist" aria-label="Settings navigation">
        <button
          id="tab-settings"
          class="tab active"
          role="tab"
          aria-selected="true"
          aria-controls="panel-settings"
          tabindex="0">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.8 4.8l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.8-4.8l4.2-4.2"/>
          </svg>
          <span>Settings</span>
        </button>
        <button
          id="tab-apiKeys"
          class="tab"
          role="tab"
          aria-selected="false"
          aria-controls="panel-apiKeys"
          tabindex="-1">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
          </svg>
          <span>API Keys</span>
        </button>
        <button
          id="tab-stats"
          class="tab"
          role="tab"
          aria-selected="false"
          aria-controls="panel-stats"
          tabindex="-1">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M3 3v18h18M18 17V9m-5 8V5m-5 12v-3"/>
          </svg>
          <span>Statistics</span>
        </button>
      </nav>

      <!-- Tab Panels -->
      <div class="tab-content">
        <!-- Settings Panel -->
        <div
          id="panel-settings"
          class="tab-panel active"
          role="tabpanel"
          aria-labelledby="tab-settings"
          tabindex="0">

          <div class="settings-group">
            <h3 class="settings-group-title">Translation Settings</h3>

            <div class="field">
              <div class="field-label-row">
                <label class="field-label">
                  Translation Model
                  <span class="field-help">Choose the AI model for translation</span>
                </label>
                <button
                  type="button"
                  class="think-chip"
                  id="geminiThinking"
                  aria-pressed="true"
                  title="Enable deep thinking for better quality (slower)"
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a8 8 0 0 1 8 8c0 3.5-2 5.5-4 7v1a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1c-2-1.5-4-3.5-4-7a8 8 0 0 1 8-8z"/>
                    <path d="M9 22h6"/>
                  </svg>
                  <span>Think</span>
                </button>
              </div>
              <div class="button-group" role="group" aria-label="Translation model selection">
                <button
                  type="button"
                  class="button-group-item active"
                  id="flashBtn"
                  data-value="gemini-flash-latest"
                  aria-pressed="true"
                >
                  <span>Flash</span>
                </button>
                <button
                  type="button"
                  class="button-group-item"
                  id="liteBtn"
                  data-value="gemini-flash-lite-latest"
                  aria-pressed="false"
                >
                  <span>Lite</span>
                </button>
                <button
                  type="button"
                  class="button-group-item"
                  id="proBtn"
                  data-value="gemini-pro-latest"
                  aria-pressed="false"
                >
                  <span>Pro</span>
                </button>
              </div>
            </div>

            <div class="field">
              <label for="targetLanguage" class="field-label">
                Target Language
                <span class="field-help">Type any language or choose from suggestions</span>
              </label>
              <div class="combobox-wrapper">
                <input
                  type="text"
                  id="targetLanguage"
                  class="combobox-input"
                  placeholder="e.g., English, Spanish, French..."
                  value="English"
                  aria-describedby="target-language-help"
                  aria-autocomplete="list"
                  aria-controls="languageSuggestions"
                  role="combobox"
                  aria-expanded="false"
                >
                <button type="button" class="combobox-clear" id="languageClear" aria-label="Clear language" tabindex="-1" style="display: none;">
                  <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <circle cx="8" cy="8" r="7" opacity="0.15" fill="currentColor"/>
                    <line x1="5" y1="5" x2="11" y2="11"></line>
                    <line x1="11" y1="5" x2="5" y2="11"></line>
                  </svg>
                </button>
                <button type="button" class="combobox-toggle" id="languageToggle" aria-label="Show language suggestions" tabindex="-1">
                  <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <ul class="combobox-menu" id="languageSuggestions" role="listbox" aria-label="Language suggestions" hidden>
                  <li class="combobox-item" role="option" data-value="English">English</li>
                  <li class="combobox-item" role="option" data-value="Spanish">Spanish</li>
                  <li class="combobox-item" role="option" data-value="French">French</li>
                  <li class="combobox-item" role="option" data-value="German">German</li>
                  <li class="combobox-item" role="option" data-value="Italian">Italian</li>
                  <li class="combobox-item" role="option" data-value="Portuguese">Portuguese</li>
                  <li class="combobox-item" role="option" data-value="Japanese">Japanese</li>
                  <li class="combobox-item" role="option" data-value="Chinese">Chinese</li>
                  <li class="combobox-item" role="option" data-value="Korean">Korean</li>
                  <li class="combobox-item" role="option" data-value="Russian">Russian</li>
                  <li class="combobox-item" role="option" data-value="Arabic">Arabic</li>
                  <li class="combobox-item" role="option" data-value="Hindi">Hindi</li>
                  <li class="combobox-item" role="option" data-value="Vietnamese">Vietnamese</li>
                  <li class="combobox-item" role="option" data-value="Thai">Thai</li>
                </ul>
              </div>
              <span id="target-language-help" class="sr-only">
                Type any language name or select from common suggestions
              </span>
            </div>

            <div class="field">
              <label class="field-label">
                Font Source
                <span class="field-help">Choose where to get fonts from</span>
              </label>
              <div class="button-group" role="group" aria-label="Font source selection">
                <button
                  type="button"
                  class="button-group-item active"
                  id="builtinChip"
                  data-value="builtin"
                  aria-pressed="true"
                >
                  <svg class="button-group-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                  </svg>
                  <span>Built-in</span>
                  <span class="button-group-badge">6</span>
                </button>
                <button
                  type="button"
                  class="button-group-item"
                  id="googleChip"
                  data-value="google"
                  aria-pressed="false"
                >
                  <svg class="button-group-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"></path>
                  </svg>
                  <span>Google</span>
                  <span class="button-group-badge">1000+</span>
                </button>
              </div>
            </div>

            <!-- Built-in Fonts Dropdown -->
            <div class="field" id="builtinFontField">
              <label for="fontFamily" class="field-label">
                Built-in Font
                <span class="field-help">Fast, offline fonts</span>
              </label>
              <div class="custom-dropdown" id="fontDropdown">
                <button type="button" class="dropdown-trigger" id="fontFamily" aria-haspopup="listbox" aria-expanded="false" aria-describedby="font-family-help">
                  <span class="dropdown-selected">Arial</span>
                  <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <ul class="dropdown-menu" role="listbox" aria-label="Built-in font options">
                  <li class="dropdown-item selected" role="option" data-value="arial" aria-selected="true">
                    <span class="dropdown-item-text">Arial</span>
                    <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </li>
                  <li class="dropdown-item" role="option" data-value="comic-sans" aria-selected="false">
                    <span class="dropdown-item-text">Comic Sans</span>
                    <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </li>
                  <li class="dropdown-item" role="option" data-value="anime-ace" aria-selected="false">
                    <span class="dropdown-item-text">Anime Ace</span>
                    <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </li>
                  <li class="dropdown-item" role="option" data-value="anime-ace-3" aria-selected="false">
                    <span class="dropdown-item-text">Anime Ace 3</span>
                    <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </li>
                  <li class="dropdown-item" role="option" data-value="ms-yahei" aria-selected="false">
                    <span class="dropdown-item-text">Microsoft YaHei (CJK)</span>
                    <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </li>
                  <li class="dropdown-item" role="option" data-value="noto-sans-mono-cjk" aria-selected="false">
                    <span class="dropdown-item-text">Noto Sans Mono (CJK)</span>
                    <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </li>
                </ul>
              </div>
              <span id="font-family-help" class="sr-only">
                Select from 6 built-in fonts optimized for manga
              </span>

              <!-- Font Preview -->
              <div class="font-preview" id="builtinFontPreview">
                <div class="font-preview-label">Preview:</div>
                <div class="font-preview-text" id="builtinFontPreviewText">
                  AaBbCc 123 あいうえお 你好
                </div>
              </div>
            </div>

            <!-- Google Fonts Combobox -->
            <div class="field" id="googleFontField" hidden>
              <label for="googleFontFamily" class="field-label">
                Google Font
                <span class="field-help">Type or choose from 1000+ fonts</span>
              </label>
              <div class="combobox-wrapper">
                <input
                  type="text"
                  id="googleFontFamily"
                  class="combobox-input"
                  placeholder="e.g., Roboto, Comic Neue, Noto Sans JP..."
                  value="Roboto"
                  aria-describedby="google-font-help"
                  aria-autocomplete="list"
                  aria-controls="googleFontSuggestions"
                  role="combobox"
                  aria-expanded="false"
                >
                <button type="button" class="combobox-clear" id="googleFontClear" aria-label="Clear font" tabindex="-1" style="display: none;">
                  <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <circle cx="8" cy="8" r="7" opacity="0.15" fill="currentColor"/>
                    <line x1="5" y1="5" x2="11" y2="11"></line>
                    <line x1="11" y1="5" x2="5" y2="11"></line>
                  </svg>
                </button>
                <button type="button" class="combobox-toggle" id="googleFontToggle" aria-label="Show font suggestions" tabindex="-1">
                  <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <ul class="combobox-menu" id="googleFontSuggestions" role="listbox" aria-label="Google Font suggestions" hidden>
                  <!-- Populated dynamically from googleFonts.ts -->
                </ul>
              </div>
              <span id="google-font-help" class="sr-only">
                Type any Google Font name or select from popular suggestions
              </span>

              <!-- Font Preview -->
              <div class="font-preview" id="fontPreview">
                <div class="font-preview-label">Preview:</div>
                <div class="font-preview-text" id="fontPreviewText">
                  AaBbCc 123 あいうえお 你好
                </div>
              </div>

              <!-- Font Status Indicator -->
              <div class="font-status" id="fontStatus" style="display: none; margin-top: var(--space-xs); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); font-size: var(--text-sm);">
                <span id="fontStatusIcon" style="margin-right: var(--space-xs);"></span>
                <span id="fontStatusText"></span>
              </div>
            </div>

          </div>

          <!-- Local OCR Options -->
          <div class="settings-group accordion-group">
            <button type="button" class="accordion-header" aria-expanded="false" aria-controls="accordion-ocr">
              <h3 class="settings-group-title">Local OCR</h3>
              <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div id="accordion-ocr" class="accordion-content" hidden>
              <div class="field field-row">
                <label for="localOcr" class="field-label">
                  Enable Local OCR
                  <span class="field-help">Use local OCR model for Japanese text recognition (faster, no API usage for OCR)</span>
                </label>
                <label class="toggle" aria-label="Toggle local OCR">
                  <input type="checkbox" id="localOcr">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div id="cerebrasOptions" class="conditional-field" hidden>
                <div class="field field-row">
                  <label for="useCerebras" class="field-label">
                    Use Cerebras for Translation
                    <span class="field-help">Use Cerebras API (~3000 tok/s) instead of Gemini</span>
                  </label>
                  <label class="toggle" aria-label="Toggle Cerebras">
                    <input type="checkbox" id="useCerebras">
                    <span class="toggle-slider" aria-hidden="true"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-group accordion-group">
            <button type="button" class="accordion-header" aria-expanded="true" aria-controls="accordion-rendering">
              <h3 class="settings-group-title">Rendering Options</h3>
              <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div id="accordion-rendering" class="accordion-content">
              <div class="field field-row">
                <label for="textStroke" class="field-label">
                  Text Stroke
                  <span class="field-help">Add outline to translated text</span>
                </label>
                <label class="toggle" aria-label="Toggle text stroke">
                  <input type="checkbox" id="textStroke">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div class="field field-row">
                <label for="includeFreeText" class="field-label">
                  Allow Free Label Text
                  <span class="field-help">Translate unstructured text in images</span>
                </label>
                <label class="toggle" aria-label="Toggle free label text">
                  <input type="checkbox" id="includeFreeText" aria-describedby="free-text-help">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
                <span id="free-text-help" class="sr-only">
                  When enabled, processes free-form text in addition to speech bubbles
                </span>
              </div>

              <div class="field field-row" id="bananaField" hidden>
                <label for="bananaMode" class="field-label">
                  Banana Mode
                  <span class="field-help">Enhanced detection for complex layouts</span>
                </label>
                <label class="toggle" aria-label="Toggle banana mode">
                  <input type="checkbox" id="bananaMode">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div class="field" id="backgroundTypeField" hidden>
                <label class="field-label">
                  Background Type
                  <span class="field-help">Background removal for free label text</span>
                </label>
                <div class="button-group" role="group" aria-label="Background type selection">
                  <button
                    type="button"
                    class="button-group-item active"
                    id="blurBgBtn"
                    data-value="blur"
                    aria-pressed="true"
                  >
                    <span>Blur</span>
                  </button>
                  <button
                    type="button"
                    class="button-group-item"
                    id="whiteBgBtn"
                    data-value="white"
                    aria-pressed="false"
                  >
                    <span>White</span>
                  </button>
                </div>
              </div>

            </div>
          </div>

          <div class="settings-group accordion-group">
            <button type="button" class="accordion-header" aria-expanded="true" aria-controls="accordion-advanced">
              <h3 class="settings-group-title">Advanced Options</h3>
              <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div id="accordion-advanced" class="accordion-content">

              <div class="field field-row">
                <label for="cache" class="field-label">
                  Enable Cache
                  <span class="field-help">Cache translations for faster reprocessing</span>
                </label>
                <label class="toggle" aria-label="Toggle cache">
                  <input type="checkbox" id="cache" checked>
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div class="field field-row">
                <label for="metricsDetail" class="field-label">
                  Detailed Metrics
                  <span class="field-help">Show comprehensive processing statistics</span>
                </label>
                <label class="toggle" aria-label="Toggle detailed metrics">
                  <input type="checkbox" id="metricsDetail" checked>
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div class="field field-row">
                <label for="tighterBounds" class="field-label">
                  Tighter Bounds
                  <span class="field-help">Use more precise text region boundaries</span>
                </label>
                <label class="toggle" aria-label="Toggle tighter bounds">
                  <input type="checkbox" id="tighterBounds">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div class="field field-row">
                <label for="filterOrphanRegions" class="field-label">
                  Filter Orphan Regions
                  <span class="field-help">Discard text regions not within speech bubbles</span>
                </label>
                <label class="toggle" aria-label="Toggle filter orphan regions">
                  <input type="checkbox" id="filterOrphanRegions">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>
            </div>
          </div>

          <div class="settings-group accordion-group">
            <button type="button" class="accordion-header" aria-expanded="true" aria-controls="accordion-server">
              <h3 class="settings-group-title">Server Options</h3>
              <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div id="accordion-server" class="accordion-content">
              <!-- Backend Info -->
              <div id="backendInfo" class="backend-info" style="display: none; margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-md); font-size: var(--text-sm);">
                <strong>Backend:</strong> <span id="backendType">Unknown</span>
                <span id="backendAcceleration" style="color: var(--text-secondary);"></span>
              </div>

              <div class="field field-row" id="mergeImgField">
                <label for="mergeImg" class="field-label">
                  Batch Inference Mode
                  <span class="field-help">Merge images for faster GPU processing</span>
                </label>
                <label class="toggle" aria-label="Toggle batch inference">
                  <input type="checkbox" id="mergeImg">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>

              <div class="field field-row" id="batchSizeField">
                <label for="batchSize" class="field-label">
                  Batch Size
                  <span class="field-help">Number of pages per batch (1-50)</span>
                </label>
                <div class="number-input-wrapper">
                  <button
                    type="button"
                    class="number-stepper-btn decrement"
                    data-target="batchSize"
                    aria-label="Decrease batch size">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                  <input
                    type="number"
                    id="batchSize"
                    class="number-input"
                    min="1"
                    max="50"
                    value="5"
                    aria-describedby="batch-size-help"
                  >
                  <button
                    type="button"
                    class="number-stepper-btn increment"
                    data-target="batchSize"
                    aria-label="Increase batch size">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                </div>
                <span id="batch-size-help" class="sr-only">
                  Higher values process more images at once but use more memory
                </span>
              </div>

              <div class="field field-row" id="sessionLimitField">
                <label for="sessionLimit" class="field-label">
                  ONNX Session Limit
                  <span class="field-help">Max sessions per model (1-32, ~82MB each)</span>
                </label>
                <div class="number-input-wrapper">
                  <button
                    type="button"
                    class="number-stepper-btn decrement"
                    data-target="sessionLimit"
                    aria-label="Decrease session limit">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                  <input
                    type="number"
                    id="sessionLimit"
                    class="number-input"
                    min="1"
                    max="32"
                    value="8"
                    aria-describedby="session-limit-help"
                  >
                  <button
                    type="button"
                    class="number-stepper-btn increment"
                    data-target="sessionLimit"
                    aria-label="Increase session limit">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                </div>
                <span id="session-limit-help" class="sr-only">
                  Controls memory usage. Sessions allocated dynamically on demand.
                </span>
              </div>

              <div class="field" id="targetSizeField">
                <label for="targetSize" class="field-label">
                  Detection Target Size
                  <span class="field-help">Model input resolution for detection</span>
                </label>
                <div class="custom-dropdown" id="targetSizeDropdown">
                  <button type="button" class="dropdown-trigger" id="targetSize" aria-haspopup="listbox" aria-expanded="false" aria-describedby="target-size-help">
                    <span class="dropdown-selected">640px (Default)</span>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </button>
                  <ul class="dropdown-menu" role="listbox" aria-label="Target size options">
                    <li class="dropdown-item" role="option" data-value="0" aria-selected="false">
                      <span class="dropdown-item-text">Original Source</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="320" aria-selected="false">
                      <span class="dropdown-item-text">320px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="480" aria-selected="false">
                      <span class="dropdown-item-text">480px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item selected" role="option" data-value="640" aria-selected="true">
                      <span class="dropdown-item-text">640px (Default)</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="896" aria-selected="false">
                      <span class="dropdown-item-text">896px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="1024" aria-selected="false">
                      <span class="dropdown-item-text">1024px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="1280" aria-selected="false">
                      <span class="dropdown-item-text">1280px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="1536" aria-selected="false">
                      <span class="dropdown-item-text">1536px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="1920" aria-selected="false">
                      <span class="dropdown-item-text">1920px</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                    <li class="dropdown-item" role="option" data-value="2048" aria-selected="false">
                      <span class="dropdown-item-text">2048px (Maximum)</span>
                      <svg class="dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                    </li>
                  </ul>
                </div>
                <span id="target-size-help" class="sr-only">
                  Higher values = better accuracy but slower. Original source uses full image resolution.
                </span>
              </div>
            </div>
          </div>

          <div class="settings-group accordion-group">
            <button type="button" class="accordion-header" aria-expanded="false" aria-controls="accordion-debug">
              <h3 class="settings-group-title">Debug Options</h3>
              <svg class="accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div id="accordion-debug" class="accordion-content" hidden>
              <div class="field field-row">
                <label for="l1Debug" class="field-label">
                  L1 Debug Mode
                  <span class="field-help">Show label 0/1 bounding boxes (BLUE=bubbles, RED=text)</span>
                </label>
                <label class="toggle" aria-label="Toggle L1 debug mode">
                  <input type="checkbox" id="l1Debug">
                  <span class="toggle-slider" aria-hidden="true"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- API Keys Panel -->
        <div
          id="panel-apiKeys"
          class="tab-panel"
          role="tabpanel"
          aria-labelledby="tab-apiKeys"
          tabindex="0"
          hidden>

          <!-- Cerebras API Key Section (shown when Cerebras mode enabled) -->
          <div id="cerebrasKeySection" class="api-keys-section cerebras-section" hidden>
            <div class="api-keys-header">
              <h3 class="settings-group-title">Cerebras API Key</h3>
              <p class="help-text">
                Fast translation with Cerebras Cloud (~3000 tokens/sec).
              </p>
            </div>

            <div class="api-key-item">
              <div class="api-key-input-wrapper">
                <input
                  type="password"
                  id="cerebrasApiKey"
                  class="api-key-input"
                  placeholder="Enter your Cerebras API key"
                  autocomplete="off">
                <button
                  type="button"
                  id="toggleCerebrasKey"
                  class="api-key-toggle-visibility"
                  aria-label="Toggle API key visibility">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="api-keys-footer">
              <a
                href="https://cloud.cerebras.ai/"
                target="_blank"
                rel="noopener noreferrer"
                class="link-external">
                Get Cerebras API Key
                <svg class="icon-external" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                </svg>
              </a>
            </div>

            <div class="section-divider"></div>
          </div>

          <!-- Gemini API Keys Section -->
          <div id="geminiKeysSection" class="api-keys-section gemini-section">
            <div class="api-keys-header">
              <h3 class="settings-group-title">Gemini API Keys</h3>
              <p class="help-text">
                Add one or more Google Gemini API keys for translation. Keys are rotated automatically.
              </p>
              <div class="api-keys-note">
                <svg class="note-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span>Create each API key in a <strong>different project</strong> to avoid hitting rate limits quickly.</span>
              </div>
            </div>

            <div id="apiKeysList" class="api-keys-list" role="list" aria-label="API Keys"></div>

            <button
              id="addApiKey"
              class="btn-secondary"
              type="button"
              aria-label="Add new API key">
              <svg class="btn-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
              </svg>
              Add API Key
            </button>

            <div class="api-keys-footer">
              <a
                href="https://makersuite.google.com/app/apikey"
                target="_blank"
                rel="noopener noreferrer"
                class="link-external">
                Get API Key from Google AI Studio
                <svg class="icon-external" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                </svg>
              </a>
            </div>
          </div>
        </div>

        <!-- Statistics Panel -->
        <div
          id="panel-stats"
          class="tab-panel"
          role="tabpanel"
          aria-labelledby="tab-stats"
          tabindex="0"
          hidden>

          <div id="statsContent" class="stats-content">
            <div class="empty-state">
              <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M3 3v18h18M18 17V9m-5 8V5m-5 12v-3"/>
              </svg>
              <h3 class="empty-title">No Statistics Available</h3>
              <p class="empty-description">
                Process some manga images to see detailed statistics and analytics.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===== TOAST NOTIFICATIONS ===== -->
  <div
    id="toast"
    class="toast"
    role="status"
    aria-live="polite"
    aria-atomic="true"
    hidden>
    <span class="toast-icon" aria-hidden="true"></span>
    <span class="toast-message"></span>
  </div>

  <!-- ===== PROCESSING OVERLAY ===== -->
  <div
    id="processingOverlay"
    class="processing-overlay"
    role="dialog"
    aria-modal="true"
    aria-labelledby="processing-title"
    hidden>
    <div class="processing-content">
      <div class="spinner" aria-hidden="true"></div>
      <h2 id="processing-title" class="processing-title">Processing Images</h2>
      <p id="processingDetail" class="processing-detail">Initializing...</p>
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      <p class="processing-hint">This may take a few moments</p>
    </div>
  </div>

</body>
</html>
