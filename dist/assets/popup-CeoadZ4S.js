const he=function(){const n=typeof document<"u"&&document.createElement("link").relList;return n&&n.supports&&n.supports("modulepreload")?"modulepreload":"preload"}(),be=function(e,n){return new URL(e,n).href},ae={},Se=function(n,o,s){let i=Promise.resolve();if(o&&o.length>0){const l=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),d=r?.nonce||r?.getAttribute("nonce");i=Promise.allSettled(o.map(u=>{if(u=be(u,s),u in ae)return;ae[u]=!0;const m=u.endsWith(".css"),v=m?'[rel="stylesheet"]':"";if(s)for(let c=l.length-1;c>=0;c--){const f=l[c];if(f.href===u&&(!m||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${u}"]${v}`))return;const g=document.createElement("link");if(g.rel=m?"stylesheet":he,m||(g.as="script"),g.crossOrigin="",g.href=u,d&&g.setAttribute("nonce",d),document.head.appendChild(g),m)return new Promise((c,f)=>{g.addEventListener("load",c),g.addEventListener("error",()=>f(Error(`Unable to preload CSS for ${u}`)))})}))}function a(l){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=l,window.dispatchEvent(r),!r.defaultPrevented)throw l}return i.then(l=>{for(const r of l||[])r.status==="rejected"&&a(r.reason);return n().catch(a)})},G={serverUrl:"http://localhost:1420",apiKeys:[],translateModel:"gemini-flash-latest",targetLanguage:"English",fontSource:"builtin",fontFamily:"arial",googleFontFamily:"Roboto",includeFreeText:!1,bananaMode:!1,textStroke:!1,backgroundType:"blur",cache:!0,metricsDetail:!0,geminiThinking:!0,tighterBounds:!0,filterOrphanRegions:!1,useMask:!0,maskMode:"fast",mergeImg:!1,batchSize:5,sessionLimit:8,targetSize:640,theme:"auto",l1Debug:!1,localOcr:!1,useCerebras:!1,cerebrasApiKey:""};async function pe(){try{const e=await chrome.storage.sync.get(Object.keys(G));return{...G,...e}}catch(e){return console.error("[Storage] Failed to load settings:",e),G}}async function xe(e){try{await chrome.storage.sync.set(e)}catch(n){throw console.error("[Storage] Failed to save settings:",n),n}}const W="cumulativeStats";async function ne(){try{return(await chrome.storage.local.get(W))[W]||{totalSessions:0,totalImages:0,totalRegions:0,totalSimpleBg:0,totalComplexBg:0,totalLabel0:0,totalLabel1:0,totalLabel2:0,totalApiCalls:0,totalInputTokens:0,totalOutputTokens:0,totalCacheHits:0,totalCacheMisses:0,totalProcessingTimeMs:0}}catch(e){return console.error("[Storage] Failed to load cumulative stats:",e),{totalSessions:0,totalImages:0,totalRegions:0,totalSimpleBg:0,totalComplexBg:0,totalLabel0:0,totalLabel1:0,totalLabel2:0,totalApiCalls:0,totalInputTokens:0,totalOutputTokens:0,totalCacheHits:0,totalCacheMisses:0,totalProcessingTimeMs:0}}}async function ke(){try{await chrome.storage.local.remove(W),console.log("[Storage] Cumulative stats reset")}catch(e){console.error("[Storage] Failed to reset cumulative stats:",e)}}class we{container;previouslyFocused=null;isActive=!1;constructor(n){this.container=n}getFocusableElements(){const n=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(",");return Array.from(this.container.querySelectorAll(n)).filter(s=>!s.hasAttribute("disabled")&&s.offsetParent!==null)}handleTab=n=>{if(!this.isActive||n.key!=="Tab")return;const o=this.getFocusableElements(),s=o[0],i=o[o.length-1];if(!(!s||!i)){if(n.shiftKey&&document.activeElement===s){n.preventDefault(),i.focus();return}!n.shiftKey&&document.activeElement===i&&(n.preventDefault(),s.focus())}};activate(){if(this.isActive)return;this.previouslyFocused=document.activeElement;const n=this.getFocusableElements();n.length>0&&n[0].focus(),document.addEventListener("keydown",this.handleTab),this.isActive=!0}deactivate(){this.isActive&&(document.removeEventListener("keydown",this.handleTab),this.previouslyFocused&&typeof this.previouslyFocused.focus=="function"&&this.previouslyFocused.focus(),this.isActive=!1)}isActivated(){return this.isActive}}function Ee(e){return new we(e)}function Le(e,n){const o=e.key.toLowerCase()===n.key.toLowerCase(),s=!!n.ctrl===(e.ctrlKey||e.metaKey),i=!!n.shift===e.shiftKey,a=!!n.alt===e.altKey;return o&&s&&i&&a}class Ie{shortcuts=[];isListening=!1;add(n){this.shortcuts.push(n)}remove(n){const o=this.shortcuts.indexOf(n);o>-1&&this.shortcuts.splice(o,1)}handleKeydown=n=>{for(const o of this.shortcuts)if(Le(n,o)){n.preventDefault(),o.handler(n);return}};listen(){this.isListening||(document.addEventListener("keydown",this.handleKeydown),this.isListening=!0)}stop(){this.isListening&&(document.removeEventListener("keydown",this.handleKeydown),this.isListening=!1)}getShortcuts(){return[...this.shortcuts]}}console.log("[Popup] Initializing...");let P="http://localhost:1420",h=null,y=null,N=null;const t={connectionStatus:document.getElementById("connectionStatus"),connectionLabel:document.getElementById("connectionLabel"),serverUrl:document.getElementById("serverUrl"),tabSettings:document.getElementById("tab-settings"),tabApiKeys:document.getElementById("tab-apiKeys"),tabStats:document.getElementById("tab-stats"),panelSettings:document.getElementById("panel-settings"),panelApiKeys:document.getElementById("panel-apiKeys"),panelStats:document.getElementById("panel-stats"),flashBtn:document.getElementById("flashBtn"),liteBtn:document.getElementById("liteBtn"),proBtn:document.getElementById("proBtn"),languageInput:document.getElementById("targetLanguage"),languageClear:document.getElementById("languageClear"),languageToggle:document.getElementById("languageToggle"),languageSuggestions:document.getElementById("languageSuggestions"),builtinChip:document.getElementById("builtinChip"),googleChip:document.getElementById("googleChip"),builtinFontField:document.getElementById("builtinFontField"),googleFontField:document.getElementById("googleFontField"),fontDropdown:document.getElementById("fontDropdown"),fontFamily:document.getElementById("fontFamily"),googleFontInput:document.getElementById("googleFontFamily"),googleFontClear:document.getElementById("googleFontClear"),googleFontToggle:document.getElementById("googleFontToggle"),googleFontSuggestions:document.getElementById("googleFontSuggestions"),fontPreviewText:document.getElementById("fontPreviewText"),builtinFontPreviewText:document.getElementById("builtinFontPreviewText"),fontStatus:document.getElementById("fontStatus"),fontStatusIcon:document.getElementById("fontStatusIcon"),fontStatusText:document.getElementById("fontStatusText"),includeFreeText:document.getElementById("includeFreeText"),bananaMode:document.getElementById("bananaMode"),bananaField:document.getElementById("bananaField"),blurBgBtn:document.getElementById("blurBgBtn"),whiteBgBtn:document.getElementById("whiteBgBtn"),backgroundTypeField:document.getElementById("backgroundTypeField"),textStroke:document.getElementById("textStroke"),cache:document.getElementById("cache"),metricsDetail:document.getElementById("metricsDetail"),geminiThinking:document.getElementById("geminiThinking"),tighterBounds:document.getElementById("tighterBounds"),filterOrphanRegions:document.getElementById("filterOrphanRegions"),mergeImg:document.getElementById("mergeImg"),batchSize:document.getElementById("batchSize"),sessionLimit:document.getElementById("sessionLimit"),targetSize:document.getElementById("targetSize"),targetSizeDropdown:document.getElementById("targetSizeDropdown"),l1Debug:document.getElementById("l1Debug"),localOcr:document.getElementById("localOcr"),cerebrasOptions:document.getElementById("cerebrasOptions"),useCerebras:document.getElementById("useCerebras"),cerebrasApiKey:document.getElementById("cerebrasApiKey"),toggleCerebrasKey:document.getElementById("toggleCerebrasKey"),cerebrasKeySection:document.getElementById("cerebrasKeySection"),geminiKeysSection:document.getElementById("geminiKeysSection"),backendInfo:document.getElementById("backendInfo"),backendType:document.getElementById("backendType"),backendAcceleration:document.getElementById("backendAcceleration"),mergeImgField:document.getElementById("mergeImgField"),batchSizeField:document.getElementById("batchSizeField"),sessionLimitField:document.getElementById("sessionLimitField"),apiKeysList:document.getElementById("apiKeysList"),addApiKey:document.getElementById("addApiKey"),statsContent:document.getElementById("statsContent"),toast:document.getElementById("toast"),processingOverlay:document.getElementById("processingOverlay"),processingDetail:document.getElementById("processingDetail"),progressFill:document.getElementById("progressFill"),processAllBtn:document.getElementById("processAllBtn"),selectImageBtn:document.getElementById("selectImageBtn")};let S="gemini-flash-latest",T="English",x="builtin",C="arial",k="Roboto",I="blur",M=640;document.addEventListener("DOMContentLoaded",async()=>{await Be(),console.log("[Popup] Ready")});async function Be(){await Ae(),y=await ne(),oe(),Pe(),De(),$e(),se()}async function Ae(){try{const e=await pe();e.serverUrl&&(P=e.serverUrl,t.serverUrl.value=P),S=e.translateModel,O(S),T=e.targetLanguage||"English",t.languageInput.value=T,x=e.fontSource||"builtin",X(x),C=e.fontFamily||"arial",ge(t.fontDropdown,C,n=>{C=n}),k=e.googleFontFamily||"Roboto",t.googleFontInput.value=k,ee(),x==="google"&&U(k),I=e.backgroundType||"blur",Z(I),t.includeFreeText.checked=e.includeFreeText,t.textStroke.checked=e.textStroke,t.bananaMode.checked=e.bananaMode,te(),t.cache.checked=e.cache,t.metricsDetail.checked=e.metricsDetail,t.geminiThinking.setAttribute("aria-pressed",String(e.geminiThinking??!0)),t.tighterBounds.checked=e.tighterBounds??!0,t.filterOrphanRegions.checked=e.filterOrphanRegions??!1,t.mergeImg.checked=e.mergeImg??!1,t.batchSize.value=String(e.batchSize??5),t.sessionLimit.value=String(e.sessionLimit??8),M=e.targetSize??640,ge(t.targetSizeDropdown,String(M),n=>{M=parseInt(n)}),t.l1Debug.checked=e.l1Debug??!1,t.localOcr.checked=e.localOcr??!1,t.useCerebras.checked=e.useCerebras??!1,t.cerebrasApiKey.value=e.cerebrasApiKey??"",Y(!1),e.apiKeys&&e.apiKeys.length>0?e.apiKeys.forEach(n=>Q(n)):Q(""),console.log("[Popup] Settings loaded")}catch(e){console.error("[Popup] Failed to load settings:",e),b("⚠️","Failed to load settings")}}async function p(){try{const e=t.apiKeysList.querySelectorAll(".api-key-input"),n=Array.from(e).map(s=>s.value.trim()).filter(s=>s.length>0),o={serverUrl:t.serverUrl.value,apiKeys:n,translateModel:S,targetLanguage:T,fontSource:x,fontFamily:C,googleFontFamily:k,includeFreeText:t.includeFreeText.checked,textStroke:t.textStroke.checked,backgroundType:I,bananaMode:t.bananaMode.checked,cache:t.cache.checked,metricsDetail:t.metricsDetail.checked,geminiThinking:t.geminiThinking.getAttribute("aria-pressed")==="true",tighterBounds:t.tighterBounds.checked,filterOrphanRegions:t.filterOrphanRegions.checked,useMask:!0,maskMode:"fast",mergeImg:t.mergeImg.checked,batchSize:Math.max(1,Math.min(50,parseInt(t.batchSize.value)||5)),sessionLimit:Math.max(1,Math.min(32,parseInt(t.sessionLimit.value)||8)),targetSize:M,l1Debug:t.l1Debug.checked,localOcr:t.localOcr.checked,useCerebras:t.useCerebras.checked,cerebrasApiKey:t.cerebrasApiKey.value.trim()};await xe(o),P=o.serverUrl,console.log("[Popup] Settings saved")}catch(e){console.error("[Popup] Failed to save settings:",e),b("✗","Failed to save settings")}}async function _(e,n=!0){const o=e==="mergeimg"?"/mergeimg-toggle":"/thinking-toggle",s=e==="mergeimg"?"Batch inference":"Gemini thinking";try{const i=await fetch(`${P}${o}`,{method:"POST"});if(i.ok){const a=await i.json(),l=e==="mergeimg"?a.merge_img_enabled:a.gemini_thinking_enabled;console.log(`[Popup] ${s} synced: ${l}`),n&&b("✓",`${s} ${l?"enabled":"disabled"}`)}else throw new Error(`HTTP ${i.status}`)}catch(i){console.error(`[Popup] Failed to sync ${s}:`,i),n&&b("⚠️",`Failed to sync ${s} with server`)}}async function Fe(){try{const e=await fetch(`${P}/health`);if(!e.ok)return;const n=await e.json();if(!n.config)return;n.backend&&Te(n.backend);const o=t.geminiThinking.getAttribute("aria-pressed")==="true",s=n.config.merge_img_enabled!==t.mergeImg.checked,i=n.config.gemini_thinking_enabled!==o;s||i?(console.log("[Popup] Server state mismatch detected, syncing frontend settings to server"),s&&(console.log(`  - MergeImg: server=${n.config.merge_img_enabled}, local=${t.mergeImg.checked} → syncing`),await _("mergeimg",!1)),i&&(console.log(`  - Thinking: server=${n.config.gemini_thinking_enabled}, local=${o} → syncing`),await _("thinking",!1)),console.log("[Popup] ✓ Frontend settings synced to server")):console.log("[Popup] ✓ Server state matches frontend, no sync needed")}catch(e){console.error("[Popup] Failed to check/sync server settings:",e)}}function Te(e){t.backendType.textContent=e,t.backendInfo.style.display="block";const n=["DirectML","DirectML+CPU","CUDA","TensorRT","CoreML"],o=["XNNPACK","OpenVINO","OpenVINO-CPU"];let s="",i=!1;n.some(a=>e.includes(a))?(s="(GPU Accelerated)",i=e.includes("DirectML")):o.some(a=>e.includes(a))?s="(CPU Accelerated)":e==="CPU"&&(s="(Slow CPU Backend)"),t.backendAcceleration.textContent=s,i?(console.log("[Popup] DirectML detected, disabling batch options"),t.mergeImg.checked=!1,t.mergeImg.disabled=!0,t.mergeImgField.style.opacity="0.5",t.mergeImgField.style.pointerEvents="none",t.batchSizeField.style.opacity="0.5",t.batchSizeField.style.pointerEvents="none",t.batchSize.disabled=!0,t.sessionLimitField.style.opacity="0.5",t.sessionLimitField.style.pointerEvents="none",t.sessionLimit.disabled=!0):(t.mergeImg.disabled=!1,t.mergeImgField.style.opacity="1",t.mergeImgField.style.pointerEvents="auto",t.batchSizeField.style.opacity="1",t.batchSizeField.style.pointerEvents="auto",t.batchSize.disabled=!1,t.sessionLimitField.style.opacity="1",t.sessionLimitField.style.pointerEvents="auto",t.sessionLimit.disabled=!1)}function Q(e=""){const n=document.createElement("div");n.className="api-key-item",n.setAttribute("role","listitem");const o=`api-key-${Date.now()}`,s=`visibility-${Date.now()}`;n.innerHTML=`
    <div class="api-key-input-wrapper">
      <input
        type="password"
        id="${o}"
        class="api-key-input"
        placeholder="AIza..."
        value="${e}"
        aria-label="API Key"
        aria-describedby="${o}-help"
      >
      <span id="${o}-help" class="sr-only">Enter your Google Gemini API key</span>
      <button
        id="${s}"
        class="api-key-toggle-visibility"
        type="button"
        aria-label="Toggle API key visibility"
        aria-pressed="false">
        <svg class="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
          <line x1="1" y1="1" x2="23" y2="23"/>
        </svg>
      </button>
    </div>
    <button
      class="api-key-remove"
      type="button"
      aria-label="Remove API key">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  `;const i=n.querySelector(".api-key-input"),a=n.querySelector(".api-key-toggle-visibility"),l=n.querySelector(".api-key-remove"),r=a.querySelector(".icon-eye"),d=a.querySelector(".icon-eye-off");a.addEventListener("click",()=>{const u=i.type==="password";i.type=u?"text":"password",r.style.display=u?"none":"block",d.style.display=u?"block":"none",a.setAttribute("aria-pressed",u?"true":"false")}),l.addEventListener("click",()=>{t.apiKeysList.querySelectorAll(".api-key-item").length>1?(n.remove(),p()):b("⚠️","At least one API key field is required")}),i.addEventListener("blur",()=>{p()}),t.apiKeysList.appendChild(n)}async function se(){console.log("[Popup] Checking connection..."),q("checking");try{const e=new AbortController,n=setTimeout(()=>e.abort(),5e3),o=await fetch(`${P}/health`,{method:"GET",signal:e.signal});if(clearTimeout(n),o.ok)q("connected"),console.log("[Popup] Connected"),await Fe();else throw new Error(`HTTP ${o.status}`)}catch(e){console.error("[Popup] Connection failed:",e),q("error"),e.name==="AbortError"?b("⚠️","Connection timeout - Check server and Local Network Access permission"):b("⚠️","Server offline or unreachable - Check Local Network Access permission")}}function q(e){t.connectionStatus.className=`status-dot ${e}`;const n={connected:"Connected",checking:"Checking...",error:"Offline"};t.connectionLabel.textContent=n[e],t.connectionStatus.setAttribute("aria-label",`Server connection status: ${n[e]}`)}function Ce(){N&&clearTimeout(N),N=setTimeout(()=>{p(),se()},1e3)}function F(e){const n=[t.tabSettings,t.tabApiKeys,t.tabStats],o=[t.panelSettings,t.panelApiKeys,t.panelStats];n.forEach((s,i)=>{const a=s.id===`tab-${e}`;s.classList.toggle("active",a),s.setAttribute("aria-selected",a?"true":"false"),s.setAttribute("tabindex",a?"0":"-1"),o[i].classList.toggle("active",a),o[i].hidden=!a})}const re=Ee(t.processingOverlay);function H(e,n="Initializing...",o=0){e?(t.processingOverlay.hidden=!1,t.processingDetail.textContent=n,t.progressFill.style.width=`${o}%`,t.progressFill.parentElement?.setAttribute("aria-valuenow",o.toString()),re.activate()):(t.processingOverlay.hidden=!0,re.deactivate())}function oe(){if((h||y&&y.totalSessions>0)&&(t.tabStats.disabled=!1),!h&&(!y||y.totalSessions===0)){t.statsContent.innerHTML=`
      <div class="empty-state">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18h18M18 17V9m-5 8V5m-5 12v-3"/>
        </svg>
        <h3 class="empty-title">No Statistics Available</h3>
        <p class="empty-description">
          Process some manga images to see detailed statistics and analytics.
        </p>
      </div>
    `;return}let e="";if(h){const o=h.label_0_count||h.label_1_count||h.label_2_count;e+=`
    <div class="settings-group" style="border-left: 3px solid var(--primary);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
        <h3 class="settings-group-title">Latest Session</h3>
        <span style="font-size: var(--text-xs); color: var(--primary); font-weight: var(--font-semibold);">RECENT</span>
      </div>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
        <div class="stat-card">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Images</div>
          <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary);">
            ${h.total_images||0}
          </div>
        </div>
        <div class="stat-card">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Regions</div>
          <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary);">
            ${h.total_regions||0}
          </div>
        </div>
      </div>
      ${o?`
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm); margin-top: var(--space-md);">
        <div style="padding: var(--space-xs); text-align: center; background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Bubbles (L0)</div>
          <div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary);">
            ${h.label_0_count||0}
          </div>
        </div>
        <div style="padding: var(--space-xs); text-align: center; background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Inner (L1)</div>
          <div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary);">
            ${h.label_1_count||0}
          </div>
        </div>
        <div style="padding: var(--space-xs); text-align: center; background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Free (L2)</div>
          <div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary);">
            ${h.label_2_count||0}
          </div>
        </div>
      </div>
      `:""}
      ${A("Processing Time",le(h.total_time_ms),!0)}
      ${h.input_tokens||h.output_tokens?A("Tokens Used",((h.input_tokens||0)+(h.output_tokens||0)).toLocaleString(),!0):""}
    </div>
    `}if(y&&y.totalSessions>0){const o=y.totalProcessingTimeMs/y.totalSessions,s=y.totalImages/y.totalSessions,i=y.totalInputTokens+y.totalOutputTokens,a=y.totalCacheHits+y.totalCacheMisses,l=a>0?(y.totalCacheHits/a*100).toFixed(1)+"%":"N/A",r=y.totalLabel0||y.totalLabel1||y.totalLabel2;e+=`
    <div class="settings-group">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
        <h3 class="settings-group-title">Lifetime Statistics</h3>
        <button id="resetStats" style="background: transparent; border: 1px solid var(--border-default); padding: 4px 8px; border-radius: var(--radius-sm); font-size: var(--text-xs); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-base);">
          Reset
        </button>
      </div>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-bottom: var(--space-md);">
        <div class="stat-card">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Total Sessions</div>
          <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary);">
            ${y.totalSessions.toLocaleString()}
          </div>
        </div>
        <div class="stat-card">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Total Images</div>
          <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary);">
            ${y.totalImages.toLocaleString()}
          </div>
        </div>
        <div class="stat-card">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Total Regions</div>
          <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary);">
            ${y.totalRegions.toLocaleString()}
          </div>
        </div>
        <div class="stat-card">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">API Calls</div>
          <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary);">
            ${y.totalApiCalls.toLocaleString()}
          </div>
        </div>
      </div>

      ${r?`
      <h3 class="settings-group-title" style="margin-bottom: var(--space-sm);">Label Breakdown</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm); margin-bottom: var(--space-md);">
        <div style="padding: var(--space-xs); text-align: center; background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Bubbles (L0)</div>
          <div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary);">
            ${(y.totalLabel0||0).toLocaleString()}
          </div>
        </div>
        <div style="padding: var(--space-xs); text-align: center; background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Inner (L1)</div>
          <div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary);">
            ${(y.totalLabel1||0).toLocaleString()}
          </div>
        </div>
        <div style="padding: var(--space-xs); text-align: center; background: var(--bg-secondary); border-radius: var(--radius-sm);">
          <div style="font-size: var(--text-xs); color: var(--text-secondary);">Free (L2)</div>
          <div style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--text-primary);">
            ${(y.totalLabel2||0).toLocaleString()}
          </div>
        </div>
      </div>
      `:""}


      <h3 class="settings-group-title" style="margin-top: var(--space-lg); margin-bottom: var(--space-md);">Averages</h3>
      ${A("Avg. Images/Session",s.toFixed(1))}
      ${A("Avg. Time/Session",le(o))}
      ${i>0?A("Total Tokens",i.toLocaleString()):""}
      ${A("Cache Hit Rate",l)}

      ${y.firstProcessedAt?`
      <div style="margin-top: var(--space-md); padding-top: var(--space-md); border-top: 1px solid var(--border-subtle); font-size: var(--text-xs); color: var(--text-tertiary); text-align: center;">
        First used: ${new Date(y.firstProcessedAt).toLocaleDateString()}
      </div>
      `:""}
    </div>
    `}t.statsContent.innerHTML=e;const n=document.getElementById("resetStats");n&&n.addEventListener("click",async()=>{confirm("Reset all lifetime statistics? This cannot be undone.")&&(await ke(),y=await ne(),oe(),b("✓","Statistics reset successfully"))})}function A(e,n,o=!1){return`
    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) 0; ${o?"margin-top: var(--space-sm);":""}">
      <span style="font-size: var(--text-sm); color: var(--text-secondary);">${e}</span>
      <span style="font-size: var(--text-sm); color: var(--text-primary);">${n}</span>
    </div>
  `}function le(e){return e?e<1e3?`${Math.round(e)}ms`:`${(e/1e3).toFixed(2)}s`:"N/A"}let j=null;function b(e,n,o=3e3){const s=t.toast.querySelector(".toast-icon"),i=t.toast.querySelector(".toast-message");s.textContent=e,i.textContent=n,t.toast.hidden=!1,t.toast.classList.add("show"),j&&clearTimeout(j),j=setTimeout(()=>{t.toast.classList.remove("show"),setTimeout(()=>{t.toast.hidden=!0},200)},o)}function Y(e=!1){const n=t.localOcr.checked,o=t.useCerebras.checked;t.cerebrasOptions.hidden=!n;const s=n&&o;t.cerebrasKeySection.hidden=!s,t.geminiKeysSection.classList.toggle("dimmed",s),e&&s&&setTimeout(()=>{F("apiKeys"),t.tabApiKeys.classList.add("highlight"),setTimeout(()=>t.tabApiKeys.classList.remove("highlight"),600),setTimeout(()=>t.cerebrasApiKey.focus(),300)},150)}function Pe(){t.serverUrl.addEventListener("input",Ce),t.serverUrl.addEventListener("blur",()=>{p(),se()}),t.includeFreeText.addEventListener("change",()=>{te(),p()}),t.textStroke.addEventListener("change",p),t.bananaMode.addEventListener("change",()=>{te(),p()}),t.cache.addEventListener("change",p),t.metricsDetail.addEventListener("change",p),t.tighterBounds.addEventListener("change",p),t.batchSize.addEventListener("change",p),t.sessionLimit.addEventListener("change",p),t.l1Debug.addEventListener("change",p),t.localOcr.addEventListener("change",()=>{Y(!1),p()}),t.useCerebras.addEventListener("change",()=>{const e=t.useCerebras.checked;Y(e),p()}),t.cerebrasApiKey.addEventListener("change",p),t.cerebrasApiKey.addEventListener("input",p),t.toggleCerebrasKey.addEventListener("click",()=>{const e=t.cerebrasApiKey.type==="password";t.cerebrasApiKey.type=e?"text":"password"}),t.mergeImg.addEventListener("change",async()=>{await p(),await _("mergeimg")}),t.geminiThinking.addEventListener("click",async()=>{const e=t.geminiThinking.getAttribute("aria-pressed")==="true";t.geminiThinking.setAttribute("aria-pressed",String(!e)),await p(),await _("thinking")}),Oe(),t.tabSettings.addEventListener("click",()=>F("settings")),t.tabApiKeys.addEventListener("click",()=>F("apiKeys")),t.tabStats.addEventListener("click",()=>F("stats")),[t.tabSettings,t.tabApiKeys,t.tabStats].forEach((e,n)=>{e.addEventListener("keydown",o=>{const s=["settings","apiKeys","stats"];if(o.key==="ArrowRight"){o.preventDefault();const i=(n+1)%s.length;F(s[i]),document.getElementById(`tab-${s[i]}`)?.focus()}else if(o.key==="ArrowLeft"){o.preventDefault();const i=(n-1+s.length)%s.length;F(s[i]),document.getElementById(`tab-${s[i]}`)?.focus()}})}),t.addApiKey.addEventListener("click",()=>{Q("");const e=t.apiKeysList.querySelectorAll(".api-key-input");e[e.length-1]?.focus()}),Me(),t.processAllBtn.addEventListener("click",()=>de("process-page-images")),t.selectImageBtn.addEventListener("click",()=>de("select-single-image"))}function Me(){document.querySelectorAll(".number-stepper-btn").forEach(n=>{const o=n.dataset.target;if(!o)return;const s=document.getElementById(o);if(!s)return;const i=n.classList.contains("increment"),a=n.classList.contains("decrement"),l=()=>{const r=parseInt(s.value)||0,d=parseInt(s.min)||0,u=parseInt(s.max)||1/0,m=s.closest(".number-input-wrapper");if(!m)return;const v=m.querySelector(".number-stepper-btn.decrement"),g=m.querySelector(".number-stepper-btn.increment");v&&(v.disabled=r<=d),g&&(g.disabled=r>=u)};n.addEventListener("click",()=>{const r=parseInt(s.value)||0,d=parseInt(s.min)||0,u=parseInt(s.max)||1/0,m=parseInt(s.step)||1;let v=r;i&&r<u?v=Math.min(r+m,u):a&&r>d&&(v=Math.max(r-m,d)),v!==r&&(s.value=String(v),s.dispatchEvent(new Event("change",{bubbles:!0})),l())}),s.addEventListener("input",l),s.addEventListener("change",l),s.addEventListener("keydown",r=>{const d=parseInt(s.min)||0,u=parseInt(s.max)||1/0;let m=parseInt(s.value)||0;r.key==="ArrowUp"?(r.preventDefault(),m<u&&(s.value=String(Math.min(m+1,u)),s.dispatchEvent(new Event("change",{bubbles:!0})),l())):r.key==="ArrowDown"&&(r.preventDefault(),m>d&&(s.value=String(Math.max(m-1,d)),s.dispatchEvent(new Event("change",{bubbles:!0})),l()))}),l()})}function De(){const e=new Ie;e.add({key:"Escape",handler:()=>{}}),e.listen()}const J="accordionState";async function $e(){const e=document.querySelectorAll(".accordion-header"),n=await fe();e.forEach(o=>{const s=o.getAttribute("aria-controls");if(!s)return;const i=document.getElementById(s);if(!i)return;const a=n[s]??!0;ce(o,i,a),o.addEventListener("click",()=>{const r=!(o.getAttribute("aria-expanded")==="true");ce(o,i,r),Ke(s,r)}),o.addEventListener("keydown",l=>{if(l.key==="ArrowDown"||l.key==="ArrowUp"){l.preventDefault();const r=Array.from(e),d=r.indexOf(o),u=l.key==="ArrowDown"?(d+1)%r.length:(d-1+r.length)%r.length;r[u].focus()}})})}function ce(e,n,o){e.setAttribute("aria-expanded",o.toString()),n.hidden=!o}async function fe(){try{return(await chrome.storage.local.get(J))[J]||{}}catch(e){return console.error("[Accordion] Failed to load state:",e),{}}}async function Ke(e,n){try{const o=await fe();o[e]=n,await chrome.storage.local.set({[J]:o})}catch(o){console.error("[Accordion] Failed to save state:",o)}}chrome.runtime.onMessage.addListener((e,n,o)=>(console.log("[Popup] Message:",e),e.action==="processing-update"?H(!0,e.details,e.progress):e.action==="processing-complete"?(H(!1),D(!1),e.analytics&&(h=e.analytics,ne().then(s=>{y=s,oe()}))):e.action==="processing-error"&&(H(!1),D(!1),b("✗",e.error)),o({status:"ok"}),!1));async function de(e){console.log(`[Popup] Triggering action: ${e}`);try{const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n?.id){b("⚠️","No active tab found");return}const o=["chrome://","chrome-extension://","edge://","about:"];if(n.url&&o.some(d=>n.url.startsWith(d))){b("⚠️","Cannot run on this page");return}D(!0),await ze(n.id);const s=await pe(),i=s.localOcr&&s.useCerebras,a={serverUrl:s.serverUrl||"http://localhost:1420",apiKeys:i?[]:s.apiKeys||[],translateModel:s.translateModel||"gemini-flash-latest",targetLanguage:s.targetLanguage||"English",fontSource:s.fontSource||"builtin",fontFamily:s.fontFamily||"arial",googleFontFamily:s.googleFontFamily||"Roboto",includeFreeText:s.includeFreeText||!1,bananaMode:s.bananaMode||!1,textStroke:s.textStroke||!1,backgroundType:s.backgroundType||"blur",cache:s.cache!==void 0?s.cache:!0,metricsDetail:s.metricsDetail!==void 0?s.metricsDetail:!0,geminiThinking:s.geminiThinking||!1,tighterBounds:s.tighterBounds!==void 0?s.tighterBounds:!0,filterOrphanRegions:s.filterOrphanRegions||!1,maskMode:s.maskMode||"fast",mergeImg:s.mergeImg||!1,batchSize:s.batchSize||5,sessionLimit:s.sessionLimit||8,targetSize:s.targetSize||640,l1Debug:s.l1Debug||!1,localOcr:s.localOcr||!1,useCerebras:s.useCerebras||!1,cerebrasApiKey:i&&s.cerebrasApiKey||""},l=e==="select-single-image"?"enter-selection-mode":"process-images";if(e==="select-single-image"){await R(n.id,{action:l,config:a},3e3),window.close();return}const r=await R(n.id,{action:l,config:a},1e4);console.log("[Popup] Response:",r),r?.success||(D(!1),b("⚠️",r?.error||"Processing failed"))}catch(n){console.error("[Popup] Action failed:",n),D(!1),b("✗",n.message||"Action failed")}}function R(e,n,o=5e3){return new Promise((s,i)=>{const a=setTimeout(()=>{i(new Error("Message timeout - content script not responding"))},o);chrome.tabs.sendMessage(e,n).then(l=>{clearTimeout(a),s(l)}).catch(l=>{clearTimeout(a),i(l)})})}async function ze(e){console.log("[Popup] Checking if content script is loaded...");try{await R(e,{action:"ping"},1e3),console.log("[Popup] Content script already loaded");return}catch(n){console.log("[Popup] Ping failed, will inject script:",n.message)}console.log("[Popup] Injecting content script...");try{await chrome.scripting.executeScript({target:{tabId:e},files:["scripts/content.js"]}),await new Promise(n=>setTimeout(n,200));try{await R(e,{action:"ping"},2e3),console.log("[Popup] Content script injected and verified")}catch{throw new Error("Script injected but not responding")}}catch(n){console.error("[Popup] Failed to inject content script:",n);const o=n.message;throw o.includes("file://")||o.includes("File access")?new Error('To use this extension on local files, enable "Allow access to file URLs" in chrome://extensions/'):new Error("Cannot access this page. Try refreshing.")}}function D(e){e?(t.processAllBtn.classList.add("loading"),t.selectImageBtn.classList.add("loading"),t.processAllBtn.disabled=!0,t.selectImageBtn.disabled=!0):(t.processAllBtn.classList.remove("loading"),t.selectImageBtn.classList.remove("loading"),t.processAllBtn.disabled=!1,t.selectImageBtn.disabled=!1)}function Oe(){Ue(),Ge(),_e(),Re(),ue(t.fontDropdown,t.fontFamily,e=>{C=e,ye(e),p()}),ue(t.targetSizeDropdown,t.targetSize,e=>{M=parseInt(e),p()}),Ne()}function _e(){t.builtinChip.addEventListener("click",()=>{x!=="builtin"&&(x="builtin",X("builtin"),ee(),p())}),t.googleChip.addEventListener("click",()=>{x!=="google"&&(x="google",X("google"),ee(),p())})}function X(e){e==="google"?(t.builtinChip.classList.remove("active"),t.builtinChip.setAttribute("aria-pressed","false"),t.googleChip.classList.add("active"),t.googleChip.setAttribute("aria-pressed","true")):(t.builtinChip.classList.add("active"),t.builtinChip.setAttribute("aria-pressed","true"),t.googleChip.classList.remove("active"),t.googleChip.setAttribute("aria-pressed","false"))}function Re(){t.blurBgBtn.addEventListener("click",()=>{I!=="blur"&&(I="blur",Z("blur"),p())}),t.whiteBgBtn.addEventListener("click",()=>{I!=="white"&&(I="white",Z("white"),p())})}function Z(e){e==="white"?(t.blurBgBtn.classList.remove("active"),t.blurBgBtn.setAttribute("aria-pressed","false"),t.whiteBgBtn.classList.add("active"),t.whiteBgBtn.setAttribute("aria-pressed","true")):(t.blurBgBtn.classList.add("active"),t.blurBgBtn.setAttribute("aria-pressed","true"),t.whiteBgBtn.classList.remove("active"),t.whiteBgBtn.setAttribute("aria-pressed","false"))}function Ue(){t.flashBtn.addEventListener("click",()=>{S!=="gemini-flash-latest"&&(S="gemini-flash-latest",O("gemini-flash-latest"),p())}),t.liteBtn.addEventListener("click",()=>{S!=="gemini-flash-lite-latest"&&(S="gemini-flash-lite-latest",O("gemini-flash-lite-latest"),p())}),t.proBtn.addEventListener("click",()=>{S!=="gemini-pro-latest"&&(S="gemini-pro-latest",O("gemini-pro-latest"),p())})}function O(e){t.flashBtn.classList.remove("active"),t.flashBtn.setAttribute("aria-pressed","false"),t.liteBtn.classList.remove("active"),t.liteBtn.setAttribute("aria-pressed","false"),t.proBtn.classList.remove("active"),t.proBtn.setAttribute("aria-pressed","false"),e==="gemini-pro-latest"?(t.proBtn.classList.add("active"),t.proBtn.setAttribute("aria-pressed","true")):e==="gemini-flash-lite-latest"?(t.liteBtn.classList.add("active"),t.liteBtn.setAttribute("aria-pressed","true")):(t.flashBtn.classList.add("active"),t.flashBtn.setAttribute("aria-pressed","true"))}function ee(){x==="google"?(t.builtinFontField.hidden=!0,t.googleFontField.hidden=!1,k&&U(k)):(t.builtinFontField.hidden=!1,t.googleFontField.hidden=!0,ye(C))}function te(){const e=t.includeFreeText.checked,n=t.bananaMode.checked;t.bananaField.hidden=!e,t.backgroundTypeField.hidden=!e||n}function Ge(){const e=t.languageInput,n=t.languageClear,o=t.languageToggle,s=t.languageSuggestions,i=s.querySelectorAll(".combobox-item");let a=!1,l=null;const r=()=>{e.value.trim()?(n.style.display="flex",n.classList.add("visible")):(n.classList.remove("visible"),setTimeout(()=>{n.classList.contains("visible")||(n.style.display="none")},150))},d=()=>{l&&(clearTimeout(l),l=null),a=!0,e.setAttribute("aria-expanded","true"),s.hidden=!1,m(e.value)},u=()=>{a=!1,e.setAttribute("aria-expanded","false"),s.hidden=!0},m=g=>{const c=g.toLowerCase().trim();let f=!1;i.forEach(L=>{const B=(L.dataset.value||"").toLowerCase().includes(c);L.hidden=!B,B&&(f=!0)}),!f&&c===""&&i.forEach(L=>L.hidden=!1)},v=g=>{e.value=g,T=g,u(),p()};n.addEventListener("mousedown",g=>{g.preventDefault(),e.value="",T="",r(),p(),setTimeout(()=>{d(),e.focus()},10)}),e.addEventListener("input",()=>{T=e.value,r(),a&&m(e.value),p()}),r(),e.addEventListener("focus",()=>{d()}),e.addEventListener("blur",()=>{l=setTimeout(()=>{u(),l=null},150)}),e.addEventListener("keydown",g=>{if(g.key==="Escape")u();else if(g.key==="ArrowDown")if(g.preventDefault(),!a)d();else{const c=Array.from(i).filter(f=>!f.hidden);c.length>0&&c[0].focus()}}),o.addEventListener("click",g=>{g.preventDefault(),a?u():(d(),e.focus())}),i.forEach(g=>{g.addEventListener("mousedown",c=>{c.preventDefault();const f=g.dataset.value;f&&(v(f),e.blur())}),g.addEventListener("keydown",c=>{if(c.key==="Enter"||c.key===" "){c.preventDefault();const f=g.dataset.value;f&&(v(f),e.focus())}else if(c.key==="Escape")u(),e.focus();else if(c.key==="ArrowDown"){c.preventDefault();const f=g.nextElementSibling;f&&!f.hidden&&f.focus()}else if(c.key==="ArrowUp"){c.preventDefault();const f=g.previousElementSibling;f&&!f.hidden?f.focus():e.focus()}})}),document.addEventListener("click",g=>{!e.contains(g.target)&&!o.contains(g.target)&&!s.contains(g.target)&&u()})}function ue(e,n,o){const s=e.querySelectorAll(".dropdown-item"),i=()=>{const d=n.getBoundingClientRect(),u=300,m=window.innerHeight-d.bottom,v=d.top;m<u&&v>m?e.classList.add("open-upward"):e.classList.remove("open-upward"),e.classList.add("open"),n.setAttribute("aria-expanded","true")},a=()=>{e.classList.remove("open"),n.setAttribute("aria-expanded","false")},l=()=>Array.from(s).findIndex(u=>u.classList.contains("selected")),r=d=>{const u=e.querySelector(".dropdown-selected");s.forEach(m=>{const v=m.dataset.value===d;if(m.classList.toggle("selected",v),m.setAttribute("aria-selected",v?"true":"false"),v){const g=m.querySelector(".dropdown-item-text")?.textContent||"";u.textContent=g,o(d)}})};n.addEventListener("click",d=>{d.stopPropagation(),e.classList.contains("open")?a():i()}),s.forEach(d=>{d.addEventListener("click",()=>{const u=d.dataset.value;u&&(r(u),a())})}),document.addEventListener("click",d=>{e.contains(d.target)||a()}),n.addEventListener("keydown",d=>{if(d.key==="Enter"||d.key===" ")d.preventDefault(),e.classList.contains("open")?a():i();else if(d.key==="Escape")a();else if(d.key==="ArrowDown"&&e.classList.contains("open")){d.preventDefault();const u=l(),m=Math.min(u+1,s.length-1);r(s[m].dataset.value)}else if(d.key==="ArrowUp"&&e.classList.contains("open")){d.preventDefault();const u=l(),m=Math.max(u-1,0);r(s[m].dataset.value)}})}function ge(e,n,o){const s=e.querySelectorAll(".dropdown-item"),i=e.querySelector(".dropdown-selected");s.forEach(a=>{const l=a.dataset.value===n;if(a.classList.toggle("selected",l),a.setAttribute("aria-selected",l?"true":"false"),l){const r=a.querySelector(".dropdown-item-text")?.textContent||"";i.textContent=r,o(n)}})}let E=null,K=!1;async function me(){if(E)return console.log(`[Google Fonts] Using cached ${E.length} fonts`),E;if(K){for(console.log("[Google Fonts] Already loading, waiting...");K;)await new Promise(e=>setTimeout(e,100));return E||[]}K=!0,console.log("[Google Fonts] Starting fetch from API...");try{console.log("[Google Fonts] Attempting: https://www.googleapis.com/webfonts/v1/webfonts?sort=popularity");const e=await fetch("https://www.googleapis.com/webfonts/v1/webfonts?sort=popularity");if(console.log(`[Google Fonts] Response status: ${e.status}`),!e.ok)throw new Error(`API returned ${e.status}`);const n=await e.json();console.log("[Google Fonts] API response received:",n);const o=n.items?.map(s=>s.family)||[];return E=o,console.log(`[Google Fonts] ✓ Successfully loaded ${o.length} fonts from API`),o}catch(e){console.error("[Google Fonts] API fetch failed:",e),console.log("[Google Fonts] Falling back to popular fonts list...");const{POPULAR_GOOGLE_FONTS:n}=await Se(async()=>{const{POPULAR_GOOGLE_FONTS:o}=await import("./googleFonts-3Y1Xh6Fh.js");return{POPULAR_GOOGLE_FONTS:o}},[],import.meta.url);return E=[...n],console.log(`[Google Fonts] ✓ Using ${E.length} popular fonts as fallback`),E}finally{K=!1}}function Ne(){const e=t.googleFontInput,n=t.googleFontClear,o=t.googleFontToggle,s=t.googleFontSuggestions,i=()=>{e.value.trim()?(n.style.display="flex",n.classList.add("visible")):(n.classList.remove("visible"),setTimeout(()=>{n.classList.contains("visible")||(n.style.display="none")},150))};let a=!1,l=null,r=null;const d=(c,f="")=>{const L=f.toLowerCase().trim();let $=c;L?($=c.filter(w=>w.toLowerCase().includes(L)),console.log(`[Google Fonts Search] Found ${$.length} matches for "${f}"`)):console.log(`[Google Fonts Search] Showing all ${c.length} fonts`);const B=$.slice(0,50);console.log(`[Google Fonts Search] Displaying ${B.length} fonts`),B.length===0?s.innerHTML='<li class="combobox-item combobox-no-results" style="color: var(--text-tertiary); font-style: italic; cursor: default;">No fonts found</li>':(s.innerHTML=B.map(w=>`<li class="combobox-item" role="option" data-value="${w}">${w}</li>`).join(""),s.querySelectorAll(".combobox-item").forEach(w=>{w.classList.contains("combobox-no-results")||w.addEventListener("mousedown",ve=>{ve.preventDefault();const ie=w.dataset.value;ie&&(g(ie),e.blur())})}))},u=async c=>{console.log(`[Google Fonts Search] Query: "${c}"`),r&&clearTimeout(r),r=setTimeout(async()=>{console.log(`[Google Fonts Search] Executing search for: "${c}"`);const f=await me();console.log(`[Google Fonts Search] Filtering ${f.length} fonts...`),d(f,c)},150)},m=async()=>{console.log("[Google Fonts] Opening menu..."),l&&(clearTimeout(l),l=null),a=!0,e.setAttribute("aria-expanded","true"),s.hidden=!1,s.innerHTML='<li class="combobox-item combobox-loading" style="color: var(--text-tertiary); font-style: italic; cursor: default;">Loading fonts...</li>';const c=await me();console.log("[Google Fonts] Menu opened with fonts loaded"),d(c,e.value)},v=()=>{a=!1,e.setAttribute("aria-expanded","false"),s.hidden=!0},g=c=>{e.value=c,k=c,v(),U(c),p()};n.addEventListener("mousedown",c=>{c.preventDefault(),e.value="",k="",i(),p(),setTimeout(()=>{m(),e.focus()},10)}),e.addEventListener("input",()=>{k=e.value,i(),a&&u(e.value),p()}),i(),e.addEventListener("change",()=>{const c=e.value.trim();c.length>=2&&U(c)}),e.addEventListener("focus",()=>{m()}),e.addEventListener("blur",()=>{l=setTimeout(()=>{v(),l=null},250)}),e.addEventListener("keydown",c=>{if(c.key==="Escape")v();else if(c.key==="ArrowDown")if(c.preventDefault(),!a)m();else{const f=s.querySelectorAll(".combobox-item:not(.combobox-no-results):not(.combobox-loading)");f.length>0&&f[0].focus()}}),o.addEventListener("click",c=>{c.preventDefault(),a?v():(m(),e.focus())}),document.addEventListener("click",c=>{!e.contains(c.target)&&!o.contains(c.target)&&!s.contains(c.target)&&v()}),i()}function z(e,n){t.fontStatus&&(t.fontStatus.style.display="flex",t.fontStatus.style.alignItems="center",e==="loading"?(t.fontStatus.style.background="var(--bg-secondary)",t.fontStatus.style.color="var(--text-secondary)",t.fontStatusIcon.textContent="⏳",t.fontStatusText.textContent=n):e==="success"?(t.fontStatus.style.background="rgba(16, 185, 129, 0.1)",t.fontStatus.style.color="rgb(16, 185, 129)",t.fontStatusIcon.textContent="✓",t.fontStatusText.textContent=n):e==="error"&&(t.fontStatus.style.background="rgba(239, 68, 68, 0.1)",t.fontStatus.style.color="rgb(239, 68, 68)",t.fontStatusIcon.textContent="✗",t.fontStatusText.textContent=n))}function qe(){t.fontStatus&&(t.fontStatus.style.display="none")}function U(e){const n=e?.trim();if(!n||n.length<2||!t.fontPreviewText){console.warn("[Font Preview] Invalid font name:",e),qe();return}t.fontPreviewText.classList.add("loading"),t.fontPreviewText.innerHTML=`
    <span style="opacity: 0.5;">AaBbCc 123 あいうえお 你好</span>
    <span class="font-loading-text">Loading ${e}...</span>
  `,z("loading",`Loading font "${n}"...`);const o="google-font-preview-link";let s=document.getElementById(o);s||(s=document.createElement("link"),s.id=o,s.rel="stylesheet",document.head.appendChild(s));const i=encodeURIComponent(n);s.href=`https://fonts.googleapis.com/css2?family=${i}&display=swap`,console.log("[Font Preview] Loading font:",n),document.fonts&&document.fonts.load?document.fonts.load(`20px "${e}"`).then(()=>{V(e),z("success",`Font "${n}" loaded successfully`),console.log("[Font Preview] Font loaded successfully:",n)}).catch(a=>{console.warn("[Font Preview] Font load error:",a),setTimeout(()=>{V(e),z("error",`Font "${n}" may not exist or failed to load`)},600)}):setTimeout(()=>{V(e),z("success",`Font "${n}" applied (verification unavailable)`)},600)}function V(e){const n=e?.trim();!t.fontPreviewText||!n||(t.fontPreviewText.style.fontFamily=`"${n}", sans-serif`,t.fontPreviewText.innerHTML="AaBbCc 123 あいうえお 你好",t.fontPreviewText.classList.remove("loading"),console.log("[Font Preview] Applied font:",n))}function ye(e){if(!t.builtinFontPreviewText)return;const o={arial:"Arial, sans-serif","comic-sans":'"Comic Sans MS", "Comic Sans", cursive',"anime-ace":'"Anime Ace", sans-serif',"anime-ace-3":'"Anime Ace 3", sans-serif',"ms-yahei":'"Microsoft YaHei", "微软雅黑", sans-serif',"noto-sans-mono-cjk":'"Noto Sans Mono CJK JP", monospace'}[e]||"Arial, sans-serif";t.builtinFontPreviewText.style.fontFamily=o,t.builtinFontPreviewText.innerHTML="AaBbCc 123 あいうえお 你好"}console.log("[Popup] Script loaded");
