console.log("[BACKGROUND] Manga Text Processor: Service worker initializing...");chrome.commands.onCommand.addListener(async t=>{if(console.log(`[BACKGROUND] Command received: ${t}`),t==="process-page-images"||t==="select-single-image")try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!o?.id){console.error("[BACKGROUND] No active tab found");return}await l(o.id);const e=await chrome.storage.sync.get(["serverUrl","apiKeys","translateModel","targetLanguage","fontSource","fontFamily","googleFontFamily","includeFreeText","bananaMode","textStroke","backgroundType","cache","metricsDetail","geminiThinking","tighterBounds","filterOrphanRegions","maskMode","mergeImg","batchSize","sessionLimit","targetSize","localOcr","useCerebras","cerebrasApiKey"]),r=e.localOcr&&e.useCerebras,s={serverUrl:e.serverUrl||"http://localhost:1420",apiKeys:r?[]:e.apiKeys||[],translateModel:e.translateModel||"gemini-flash-latest",targetLanguage:e.targetLanguage||"English",fontSource:e.fontSource||"builtin",fontFamily:e.fontFamily||"arial",googleFontFamily:e.googleFontFamily||"Roboto",includeFreeText:e.includeFreeText||!1,bananaMode:e.bananaMode||!1,textStroke:e.textStroke||!1,backgroundType:e.backgroundType||"blur",cache:e.cache!==void 0?e.cache:!0,metricsDetail:e.metricsDetail!==void 0?e.metricsDetail:!0,geminiThinking:e.geminiThinking??!0,tighterBounds:e.tighterBounds!==void 0?e.tighterBounds:!0,filterOrphanRegions:e.filterOrphanRegions||!1,maskMode:e.maskMode||"fast",mergeImg:e.mergeImg||!1,batchSize:e.batchSize||5,sessionLimit:e.sessionLimit||8,targetSize:e.targetSize||640,localOcr:e.localOcr||!1,useCerebras:e.useCerebras||!1,cerebrasApiKey:r&&e.cerebrasApiKey||""},n=t==="select-single-image"?"enter-selection-mode":"process-images",i=await chrome.tabs.sendMessage(o.id,{action:n,config:s});console.log("[BACKGROUND] Response:",i)}catch(o){console.error("[BACKGROUND] Failed to process:",o)}});function c(t,o){return Promise.race([t,new Promise((e,r)=>setTimeout(()=>r(new Error("Operation timed out")),o))])}async function l(t){try{if((await c(chrome.tabs.sendMessage(t,{action:"ping"}),500))?.loaded){console.log(`[BACKGROUND] Content script already loaded in tab ${t}`);return}}catch{}console.log(`[BACKGROUND] Injecting content script into tab ${t}...`);try{const e=(await chrome.tabs.get(t)).url||"";if(console.log(`[BACKGROUND] Tab URL: ${e.substring(0,80)}`),!e||e.startsWith("chrome://")||e.startsWith("chrome-extension://"))throw new Error("Cannot inject into this page type");if(e.startsWith("file://")&&console.log("[BACKGROUND] Detected file:// URL, checking access..."),e.startsWith("blob:")){console.log("[BACKGROUND] Blob URL detected - checking if manifest injected script..."),await new Promise(n=>setTimeout(n,500));try{if((await c(chrome.tabs.sendMessage(t,{action:"ping"}),1e3))?.loaded){console.log("[BACKGROUND] Content script found in blob URL tab");return}}catch{}throw new Error("Blob URLs require page refresh. Please refresh and try again.")}const r=await chrome.scripting.executeScript({target:{tabId:t},files:["scripts/content.js"]});if(console.log("[BACKGROUND] Injection result:",r),await new Promise(n=>setTimeout(n,200)),(await c(chrome.tabs.sendMessage(t,{action:"ping"}),1e3))?.loaded)console.log(`[BACKGROUND] Content script verified in tab ${t}`);else throw new Error("Script injected but not responding")}catch(o){const e=o.message;console.error(`[BACKGROUND] Injection failed for tab ${t}: ${e}`);try{if(((await chrome.tabs.get(t)).url||"").startsWith("file://"))throw new Error('File access not enabled. Go to chrome://extensions/, find "Manga Text Processor", and enable "Allow access to file URLs"')}catch{}throw new Error(`Cannot access page: ${e}`)}}chrome.runtime.onMessage.addListener((t,o,e)=>(console.log("[BACKGROUND] Message received:",t),t.action==="fetch-image"&&t.url?(g(t.url).then(s=>{e({success:!0,base64:s})}).catch(s=>{console.error("[BACKGROUND] Failed to fetch image:",s),e({success:!1,error:s.message})}),!0):(["processing-update","processing-complete","processing-error"].includes(t.action)&&chrome.runtime.sendMessage(t).catch(s=>{console.log("[BACKGROUND] Could not forward to popup:",s.message)}),e({status:"received"}),!1)));async function g(t){const o=new AbortController,e=setTimeout(()=>o.abort(),3e4);try{const r=await fetch(t,{signal:o.signal});if(clearTimeout(e),!r.ok)throw new Error(`Fetch failed: ${r.status} ${r.statusText}`);const s=await r.blob();return new Promise((n,i)=>{const a=new FileReader;a.onloadend=()=>{typeof a.result=="string"?n(a.result):i(new Error("Failed to convert to base64"))},a.onerror=()=>i(new Error("FileReader error")),a.readAsDataURL(s)})}catch(r){throw clearTimeout(e),r.name==="AbortError"?new Error("Image fetch timeout after 30 seconds"):r}}chrome.runtime.onInstalled.addListener(t=>{if(console.log("[BACKGROUND] Extension installed/updated:",t.reason),t.reason==="install"){const o={serverUrl:"http://localhost:1420",apiKeys:[],translateModel:"gemini-flash-latest",targetLanguage:"English",fontSource:"builtin",fontFamily:"arial",googleFontFamily:"Roboto",includeFreeText:!1,bananaMode:!1,textStroke:!1,backgroundType:"blur",cache:!0,metricsDetail:!0,geminiThinking:!0,tighterBounds:!0,filterOrphanRegions:!1,maskMode:"fast",mergeImg:!1,batchSize:5,sessionLimit:8,targetSize:640,theme:"auto",localOcr:!1,useCerebras:!1,cerebrasApiKey:""};chrome.storage.sync.set(o),console.log("[BACKGROUND] Default settings initialized")}console.log("[BACKGROUND] Content scripts will be injected on-demand when needed")});console.log("[BACKGROUND] Service worker ready");console.log("[BACKGROUND] Keyboard shortcuts: Alt+Q (Process All), Alt+W (Select Image)");
