console.log("[BACKGROUND] Manga Text Processor: Service worker initializing...");chrome.commands.onCommand.addListener(async t=>{if(console.log(`[BACKGROUND] Command received: ${t}`),t==="process-page-images"||t==="select-single-image")try{const[r]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!r?.id){console.error("[BACKGROUND] No active tab found");return}const e=await chrome.storage.sync.get(["serverUrl","apiKeys","translateModel","includeFreeText","bananaMode","textStroke","blurFreeTextBg","cache","metricsDetail","geminiThinking","tighterBounds","useMask","mergeImg","batchSize","sessionLimit"]),o={serverUrl:e.serverUrl||"http://localhost:1420",apiKeys:e.apiKeys||[],translateModel:e.translateModel||"gemini-flash-latest",includeFreeText:e.includeFreeText||!1,bananaMode:e.bananaMode||!1,textStroke:e.textStroke||!1,blurFreeTextBg:e.blurFreeTextBg||!1,cache:e.cache!==void 0?e.cache:!0,metricsDetail:e.metricsDetail!==void 0?e.metricsDetail:!0,geminiThinking:e.geminiThinking||!1,tighterBounds:e.tighterBounds!==void 0?e.tighterBounds:!0,useMask:e.useMask!==void 0?e.useMask:!0,mergeImg:e.mergeImg||!1,batchSize:e.batchSize||5,sessionLimit:e.sessionLimit||8},s=t==="select-single-image"?"enter-selection-mode":"process-images",i=await chrome.tabs.sendMessage(r.id,{action:s,config:o});console.log("[BACKGROUND] Response:",i)}catch(r){console.error("[BACKGROUND] Failed to process:",r)}});chrome.runtime.onMessage.addListener((t,r,e)=>(console.log("[BACKGROUND] Message received:",t),t.action==="fetch-image"&&t.url?(c(t.url).then(s=>{e({success:!0,base64:s})}).catch(s=>{console.error("[BACKGROUND] Failed to fetch image:",s),e({success:!1,error:s.message})}),!0):(["processing-update","processing-complete","processing-error"].includes(t.action)&&chrome.runtime.sendMessage(t).catch(s=>{console.log("[BACKGROUND] Could not forward to popup:",s.message)}),e({status:"received"}),!1)));async function c(t){const r=new AbortController,e=setTimeout(()=>r.abort(),3e4);try{const o=await fetch(t,{signal:r.signal});if(clearTimeout(e),!o.ok)throw new Error(`Fetch failed: ${o.status} ${o.statusText}`);const s=await o.blob();return new Promise((i,n)=>{const a=new FileReader;a.onloadend=()=>{typeof a.result=="string"?i(a.result):n(new Error("Failed to convert to base64"))},a.onerror=()=>n(new Error("FileReader error")),a.readAsDataURL(s)})}catch(o){throw clearTimeout(e),o.name==="AbortError"?new Error("Image fetch timeout after 30 seconds"):o}}chrome.runtime.onInstalled.addListener(t=>{if(console.log("[BACKGROUND] Extension installed/updated:",t.reason),t.reason==="install"){const r={serverUrl:"http://localhost:1420",apiKeys:[],translateModel:"gemini-flash-latest",includeFreeText:!1,bananaMode:!1,textStroke:!1,blurFreeTextBg:!1,cache:!0,metricsDetail:!0,useMask:!0,mergeImg:!1,batchSize:5,sessionLimit:8,theme:"auto"};chrome.storage.sync.set(r),console.log("[BACKGROUND] Default settings initialized")}});console.log("[BACKGROUND] Service worker ready");console.log("[BACKGROUND] Keyboard shortcut: Ctrl+Shift+M (Cmd+Shift+M on Mac)");
